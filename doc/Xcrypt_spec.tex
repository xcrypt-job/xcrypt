\documentclass[a4paper,10pt]{jarticle}

\usepackage[dvips,dvipdfm,bookmarks=true,%
  bookmarksnumbered=true,% しおりに見出し番号をつける
  bookmarksopen=true,% しおりのツリーを開く
  breaklinks=true,% ハイパーリンクが複数行にまたがってもよい
  colorlinks=false,% ハイパーリンクを枠ではなく文字に色をつけて表現
  linkcolor=red,%
  citecolor=green,%
  bookmarksopen=true,% PDFしおりを展開
  pdfstartview=FitH,%
  bookmarkstype=toc,% PDFしおりに使うべき目次情報
  pdftitle={Xcrypt Language System Specification},%
  pdfauthor={E-Science Group, Nakashima Laboratory, ACCMS, Kyoto University}]{hyperref}
\AtBeginDvi{\special{pdf:tounicode EUC-UCS2}}

\usepackage{tascmac}
\usepackage{ascmac}
\usepackage{alltt}
\usepackage{fancybox}
%\usepackage[all]{xy}

%\addtolength{\topmargin}{-50pt}
%\addtolength{\textheight}{80pt}
\addtolength{\oddsidemargin}{-35pt}
\addtolength{\textwidth}{70pt}

%
\def\|{\verb|} %|
%

\title{Xcrypt言語仕様}
\author{E-Science Group, Nakashima Laboratory, ACCMS, Kyoto University}

\begin{document}
\maketitle
\tableofcontents

\section{Overview}

In using a high-performance computer, we usually commit job processing
to a job scheduler.  At this time, we often go through the following
procedures:
\begin{itemize}
\item to create a script in its writing style depending on the
      job scheduler,
\item to pass the script to the job scheduler, and
\item to extract data from its result, create another script from
      the data, and pass it to the job scheduler.
\end{itemize}

However, such procedures require manual intervention cost.  It
therefore seems better to remove manual intervention in mid-processing
by using an appropriate script language.  Xcrypt is a script language
for job parallelization.  We can deal with jobs as objects (called
\textit{job objects}) in Xcrypt and manipulate the jobs as well as
objects in an object-oriented language.  Xcrypt provides some
functions and modules for facilitating job generation, submission,
synchronization, etc.  Xcrypt makes it easy to write scripts to process
job, and supports users to process jobs easily.

\section{用語}
\begin{description}
\item[バッチスケジューラ]
  スーパーコンピュータ等大規模計算システムにおける計算資源の利用状況を管理し，
  ユーザからシステム上で行いたい処理（ジョブ）の要求があれば，資源の空き状況
  などに基づいて適切にジョブに計算資源を割当て，実行させるソフトウェア．
  NQS，SGE，Torqueなど．
  ユーザは実行したい処理や実行に必要とする計算資源量などを
  記述したスクリプト（ジョブスクリプト）を入力としてジョブを投入すると，
  バッチスケジューラはそれを自身が管理する「ジョブキュー」にいったん追加し，
  ジョブの実行が可能と判断されたタイミングでキューから取り除き，
  ジョブへの計算資源の割当て・実行指示を行う．
\item[request ID]
  バッチスケジューラが，投入されたジョブを識別するためのユニークなID．
\item[ジョブオブジェクト]
  Xcrypt上において，これから投入しよがうとする，あるいは投入したジョブを
  表現するオブジェクト．下記のジョブIDの文字列などをメンバに持つ．
\item[ジョブID]
  Xcrypt上でジョブオブジェクトを識別するための文字列．
  基本的にrequest IDと1対1対応である．\footnote{
    一度投入したジョブが失敗・ユーザによるキャンセルなどにより
    再投入された場合には複数のrequest IDが1つのジョブIDに対応する
    ことになるが，その場合でも最新のrequest IDとジョブIDとの対応は
    一対一になる．
  }
\end{description}


\section{動作環境}\label{sec:requirement}
\begin{itemize}
\item Bourne shell互換のシェルスクリプト
\item
  Perl Version 5.8.5 以上．なお，以下のCPANパッケージを利用する
  （Xcryptの配布パッケージに含まれる）．
  \begin{itemize}
  \item Sherzod Ruzmetov's Config-Simple,
  \item Marc Lehmann's Coro (where conftest.c is not contained), EV,
  \item Gurusamy Sarathy's Data-Dumper,
  \item Graham Barr's Error,
  \item Joshua Nathaniel Pritikin's Event,
  \item Salvador Fandi\~no's Net-OpenSSH,
  \item Daniel Muey's Recursive,
  \item H.Merijn Brand and Jochen Wiedmann's Text-CSV\_XS, and
  \item Marc Lehmann's AnyEvent, common::sense, and Guard.
  \end{itemize}
\item
  バッチスケジューラがインストールされた
  環境では，そのバッチスケジューラ用の設定ファイルを記述することにより，
  Xcryptからそのバッチスケジューラのジョブを投入することができる．
  バッチスケジューラは，以下の要件をみたす必要がある．
  \begin{itemize}
  \item
    ジョブの投入をバッチスケジューラに依頼し，
    投入されたジョブのrequest IDを含むメッセージを標準出力に出力する
    ジョブ投入コマンド（\texttt{qsub}等）を提供すること．
  \item
    ジョブ投入コマンドにより投入され実行待ちとなっているジョブおよび実行中
    のジョブのrequest IDの一覧を含むメッセージを標準出力に出力する
    ジョブ確認コマンド（\texttt{qstat}等）を提供すること．
  \item
    実行待ちあるいは実行中のジョブのrequest IDをパラメータとして与えると，
    そのジョブの実行を取り消すジョブ中止コマンド（\texttt{qdel}等）
    を提供すること．
  \item
    ジョブの実行が行われるノードと，ジョブ投入・確認・中止コマンドを
    実行するノードで（NFS等により）共有されるファイルシステムが
    存在すること．
  \end{itemize}
\end{itemize}


\section{Xcryptスクリプト}
\subsection{スクリプトの構成}
Xcryptスクリプトは以下の構成を持つテキストファイルであり，
``.xcr''を拡張子とするファイル名で保存されなければならない．
\begin{screen}
\texttt{use qw(}[\textit{module-name}$_1$ \ldots \textit{module-name}$_n]$ \texttt{core);}\\
\textit{script-body}
\end{screen}
ここで，\textit{module-name}$_k (1\leq k \leq n)$はこのXcryptスクリプト
が使用するモジュール名である．

\textit{script-body}はXcryptスクリプト本体であり，追加の\texttt{use}文を
含むほぼ通常のPerlプログラムを書くことができる．ただし，以下の点において
Perlとは異ならる．
\begin{itemize}
\item
  デフォルトのネームスペース名は\texttt{main}ではなく\texttt{user}である．
\item
  \ref{sec:api}節で述べるXcryptのコア機能のほか，\textit{module-name}$_1$
  \ldots \textit{module-name}$_n$のモジュールの機能を利用する
  ことができる．また，\ref{sec:requirement}節で列挙したCPANモジュールが
  暗黙のうちに読み込まれている．
\end{itemize}

\subsection{標準API}\label{sec:api}
\subsubsection{builtin::prepare}
\paragraph{引数}
\begin{itemize}
\item
  \texttt{\%}\textit{template}: ジョブテンプレート
\end{itemize}
\paragraph{返り値}
\begin{itemize}
\item
  スカラコンテキストにおいては生成したジョブオブジェクトの数
\item
  リストコンテキストにおいては生成した全てのジョブオブジェクトを要素に持つ配列
\end{itemize}

引数として与えられたハッシュオブジェクト（ジョブテンプレート）の情報を
もとに，0個以上のジョブオブジェクトを生成し，返り値として返す．ジョブ
テンプレートはPerlのハッシュオブジェクトであり，以下の名前のメンバを持
つことができる．これ以外の名前のメンバが含まれていた場合は，警告メッセー
ジを表示し，そのメンバは無視される．また，\|id|，\|id@|いずれかの指定
は必須であり，指定なしに呼び出された場合はエラーを発生する．

\begin{enumerate}
  \item \|RANGE|$n$（\textit{n}は自然数），\|RANGES|．ただし，この両者を同時に使用してはならない．
  \item \|id|
  \item \|exe|$n$（\textit{n}は自然数）
  \item \|arg|$n$\|_|$m$（$n, m$は自然数）
  \item 
    \|exe|, \|initially|, \|finally|, \|env|, \|transfer_variable|,
    \|transfer_reference_level|, \|not_transfer_info|, \|initially|,
    \|before|, \|before_to_job|, \|before_return|, \|before_bkup|,
    \|before_in_job|, \|before_in_xcrypt|, \|before_in_xcrypt_return|,
    \|finally|, \|after|,  \|after_to_job|, \|after_return|,
    \|after_bkup|, \|after_in_job|, \|after_in_xcrypt|,\break
    \|after_in_xcrypt_return|, \|cmd_before_exe|, \|cmd_after_exe|,
    \|header|
  \item \|JS_|で始まるメンバ名
  \item \|:|で始まるメンバ名
  \item \|buildin::add_key|関数によって登録されたメンバ名
  \item \|buildin::add_prefix_of_key|関数によって登録された文字列から始まるメンバ名
  \item    
    2.--9. のメンバ名の最後に\|@|を追加したメンバ名．ただし，同じメン
    バ名に対して\|@|を追加した名前と追加していない名前のメンバを同時に
    指定してはならない．
\end{enumerate}

\|prepare|は呼び出されるとまず，以下の通りジョブオブジェクト（列）を生成し，
メンバの設定を行う．

\begin{itemize}
\item ジョブテンプレートが\|RANGE|$n$，\|RANGES|をメンバに持たない場合\\
  単一のジョブオブジェクトを生成し，ジョブテンプレートが持つ全てのメンバ
  と同じ名前・値のメンバを設定する．
  
\newcommand\mboxit[1]{\mbox{\textit{#1}}}
\def\namae{\mboxit{name}}

\item ジョブテンプレートが\|RANGE0|, \ldots, \|RANGE|$n$をメンバに持つ場合\\
\|RANGE0|, \ldots, \|RANGE|$n$の値は，それぞれPerlの配列への参照
$\mbox{\texttt{@}}A_0, \ldots, \mbox{\texttt{@}}A_n$でなければならず，
ジョブオブジェクトは
$$
R = \{ (i_0, \ldots, i_n)\ |\ i_0 \le \|$#|A_0, \ldots, i_n \le\|$#|A_n \}
\quad (i_0, \ldots, i_n は自然数)
$$
の各要素に対応してそれぞれ生成する．Rの要素$(i_0, \ldots, i_n)$
に対応するジョブオブジェクトを$J(i_0, \ldots, i_n)$とすると，
ジョブテンプレートが``\namae''または``\namae\|@|''
の名前のメンバを$v_{\mbox{\textit{name}}}$を値として持つような
{\namae}それぞれに対して（前述の通り，ジョブテンプレートが
``\namae''と``\namae\|@|''を同時にメンバとして持つことはない．），
$J(i_0, \ldots, i_n)$のメンバを以下のように設定する．
\|RANGE0|, \ldots, \|RANGE|$n$および\|RANGES|に対しては以下の設定は
行わない．また，以下によるもの以外に，メンバ\|VALUE|が
$\|$|A\|[|i_0\|]|$, \ldots, $\|$|A\|[|i_n\|]|$を値とする配列への
参照を値として設定される．

\begin{enumerate}
\item ジョブテンプレートが``\namae''をメンバとして持つ場合
  \begin{enumerate}
  \item $\namae = \|id|$の場合\\
    $J(i_0, \ldots, i_n)$のメンバ\|id|に\\
    \quad $v_{\namae}$\|.|\textit{sep}\|.|$i_0$\ldots\|.|\textit{sep}\|.|$i_n$\\
    を設定する．ただし，\textit{sep}は\|buidin::set_separator|関数で設定された
    セパレータ文字列である（デフォルトは`\|_|'）．
  \item $\namae \neq \|id|$の場合\\
    $J(i_0, \ldots, i_n)$のメンバ''\namae''に$v_{\namae}$を値として設定する．
  \end{enumerate}
\item ジョブテンプレートが``\namae\|@|''をメンバとして持つ場合
  \begin{enumerate}
  \item $v_{\namae}$が配列$\|@|V$への参照の場合
    $J(i_0, \ldots, i_n)$のメンバ''\namae''の値として，
    $\|$|V\|[|\mboxit{count}\|]|$ %$
    を設定する．ここで，\mboxit{count}は\|prepare|関数の呼び出しで生成される
    全てのジョブオブジェクトを直列に並べたときの通し番号であり，以下の式で定まる．
    $$
    \begin{array}{l}
      \mboxit{count} = i_n \times B_{n-1} + \ldots + i_1 \times B_0 + i_0 \\
      \mbox{where}\quad B_k = \prod_{j=0}^k (\|$#|A_j + 1) %$
    \end{array}
    $$
  \item $v_{\namae}$が関数への参照の場合\\
    参照先の関数$v_{\namae}$が以下のように呼び出され，
    その返り値を$J(i_0, \ldots, i_n)$のメンバ''\namae''の値として設定する．
    \begin{itemize}
    \item ジョブテンプレートへの参照が第1引数として渡される
    \item $\|$|A\|[|i_0\|]|$, \ldots, $\|$|A\|[|i_n\|]|$の値がそれぞれ第2引数--第$(n+2)$引数として渡される
    \item
      関数の実行中，変数\|$user::self|を用いて%$
      生成途中のジョブオブジェクト$J(i_0, \ldots, i_n)$への参照にアクセスできる．
      このジョブオブジェクトには少なくとも上記1. により決定される
      メンバが設定済みである．
    \item
      関数の実行中，変数\|@user::VALUE|を用いて %$
      配列\|(|$\|$|A\|[|i_0\|]|$, \ldots, $\|$|A\|[|i_n\|]|$\|)|にアクセスできる．
    \end{itemize}
  \item $v_{\namae}$がスカラ値への参照の場合\\
    $J(i_0, \ldots, i_n)$のメンバ''\namae''の値として，
    $v_{\namae}$の参照先のスカラ値を設定する．
  \item それ以外の場合\\
    警告を発生し，$J(i_0, \ldots, i_n)$のメンバ''\namae''の値として
    任意の値を設定する．
  \end{enumerate}
\end{enumerate}

\item ジョブテンプレートが\|RANGES|をメンバに持つ場合\\
  \|RANGES|の値は，配列への参照$R_0, \ldots, R_n$からなる配列への参照
  $$
  \quad \|[|R_0\|,| \ldots\|,| R_n\|]|
  $$
  でなければならず，
  $$
  \|RANGE0| = R_0, \ldots, \|RANGE|n = R_n
  $$
  が設定された場合と同様にジョブオブジェクト列の生成およびメンバの設定を行う．
\end{itemize}

ジョブオブジェクト（列）の生成とメンバ設定の終了後，各ジョブオブジェクトに対して，
クラスメソッド
\textit{module-name}$_1$\|::new|, \ldots \textit{module-name}$_n$\|::new|, \|core::new|
のうち定義されている最初のものを呼び出す．
\|new|メソッドには第1引数としてモジュール名の文字列\|$class|，%$
第2引数として対応するジョブオブジェクトへの参照\|$self|が渡される．%$
\|core::new|以外の各\|new|メソッドでは，モジュールの機能を達成するために
ジョブオブジェクト生成時に必要となる処理が行われる．また，これらのメソッドは，
$$
  \|$self = $class->NEXT::new($class, $self);|
$$
に相当する処理を1度だけ実行することにより，
次の\|new|メソッドを呼び出す（すなわち，\|core::new|が必ず1度呼び出される）
ことを保証するように実装されている．

なお，\|core::new|はXcryptシステムが提供するものであり，必ず定義されている．
\|core::new|メソッドは，ジョブオブジェクトに対し，以下の処理を行う．
ただし，以下において\textit{id}は当該ジョブオブジェクトのメンバ\|id|の値として
設定された文字列，\textit{sched}はデフォルトスケジューラ名（\ref{sec:sched}節）である．
\begin{itemize}
\item メンバ\|workdir|が未設定であれば，値を文字列\|'.'|として設定する．
\item メンバ\|env|が未設定であれば，値をデフォルトの環境オブジェクト（\ref{sec:env}節）への参照として設定する．
\item メンバ\|JS_stdout|が未設定であれば，値を文字列\|"|\textit{id}\|_stdout"|として設定する．
\item メンバ\|JS_stderr|が未設定であれば，値を文字列\|"|\textit{id}\|_stderr"|として設定する．
\item メンバ\|jobscript_header|，\|jobscript_body|が未設定であれば，値を空の配列への参照として設定する．
\item メンバ\|jobscript_file|が未設定であれば，値を文字列\|"|\textit{id}\|_|\textit{env}\|_stdout"|として設定する．
\item メンバ\|before_in_job_file|が未設定であれば，値を文字列\|"|\textit{id}\|_before_in_job.pl"|として設定する．
\item メンバ\|exe_in_job_file|が未設定であれば，値を文字列\|"|\textit{id}\|_exe_in_job.pl"|として設定する．
\item メンバ\|after_in_job_file|が未設定であれば，値を文字列\|"|\textit{id}\|_after_in_job.pl"|として設定する．
\item メンバ\|qsub_options|が未設定であれば，値を空の配列への参照として設定する．
\item 
    メンバ\|not_transfer_info|が未設定であれば，値を
  \|'dumped_environment'|, \|'before_in_job_script'|,
  \|'exe_in_job_script'|, \|'after_in_job_script'|の4つの文字列を要素
  として持つ配列への参照として設定する．\|not_transfer_info|が定義済み
  であり，かつその値が配列への参照であれば，これら4つの文字列をその配
  列に追加する．それ以外の場合，警告を表示し，メンバの値をこれら4つ文
  字列を持つ配列への参照に上書きする．
\item メンバ\|cmd_before_exe|，\|cmd_after_exe|が未設定であれば，値を空の配列への参照として設定する．
\item メンバ\|header|が未設定であれば，値を空の配列への参照として設定する．
\item ジョブの状態（\ref{sec:status}節）をinitializedに遷移させ，直後にpreparedに遷移させる．
  \footnote{
    現在のXcryptにおいては，initializedとpreparedの2つの状態を区別する必要がないが，
    後方互換性のために残している．
  }
\end{itemize}

\|new|メソッドの呼び出し完了後，以下の通り値を返す．
\begin{itemize}
\item \|prepare|関数がスカラコンテキストで呼び出されていた場合\\
  生成したジョブオブジェクトの数
\item \|prepare|関数がリストコンテキストで呼び出されていた場合\\
  生成した全てのジョブオブジェクトの参照からなる配列．配列中の参照の順序は任意である．
\end{itemize}

\subsubsection{submit}
\paragraph{引数}
\begin{itemize}
\item
  \texttt{\@}\textit{jobs}: ジョブオブジェクトへの参照の配列
\end{itemize}
\paragraph{返り値}
\begin{itemize}
\item
  スカラコンテキスト：生成したジョブスレッドの数
\item
  リストコンテキスト：生成したジョブスレッドの配列
\end{itemize}

\texttt{\@}\textit{jobs}に含まれるそれぞれジョブオブジェクトの参照
（以下，この参照を持つ変数を\|$self|とする）に対して，%$
以下の処理を行う．

\begin{enumerate}
\item
  \|$self->make_dumped_environment|メソッド（\ref{sec:make_dumped_environment}節） %$
  を呼び出して，Xcryptの環境をシリアライズした文字列を保存する．
\item
  以下の処理を非同期に実行するスレッド\footnote{
    ここでいう「スレッド」はCPANのCoroモジュールにおけるスレッドであり，
    非同期に動作するが，複数のスレッドが同時に進行することはない．
  }（ジョブスレッド）を生成し，そのスレッドを\|$self->{thread}|に代入する．%$
  \begin{enumerate}
  \item
    ジョブの状態に基づき，以下の処理を行う．
    \begin{itemize}
    \item ジョブがシグナル（\ref{sec:signal}節）を受けていない場合\\
      ジョブの前回の終了状態（\ref{sec:laststate}節）がfinishedの場合，
      ジョブの状態をfinishedに強制的に遷移させ，ジョブスレッドを終了する．
      前回の終了状態がそれ以外の場合，何も行わない．
    \item ジョブがabortシグナルを受けている場合\\
      シグナルを解除する．前回の終了状態（\ref{sec:laststate}節）がfinishedの場合，
      ジョブの状態をfinishedに強制的に遷移させ，ジョブスレッドを終了する．
      前回の終了状態がそれ以外の場合，前回の終了状態を削除する．
    \item ジョブがcancelシグナルを受けている場合\\
      シグナルの解除，および前回の終了状態の削除を行う．
    \item ジョブがinvalidateシグナルを受けている場合\\
      ジョブの状態をfinishedに強制的に遷移させ，
      ジョブスレッドを終了する．
    \end{itemize}
  \item
    \textit{module-name}$_1$\|::initially|, \ldots \textit{module-name}$_n$\|::initially|,
    \|core::initially|のうち，定義されているものをこの順に全て呼び出す
  \item
    \|$self->{before_in_xcrypt}|が定義されていれば呼び出す %$
  \item
    ジョブがシグナルを受けていない，かつ
    ジョブの前回の終了状態が設定されていないか，initialized, prepared
    のいずれかであれば，以下の処理を行う．
    \begin{itemize}
      \item
        \|$self->{before_to_job}|%$
        が真の場合，
    \textit{module-name}$_1$\|::before|, \ldots \textit{module-name}$_n$\|::before|,
    \|core::before|のうち，定義されているものをこの順に全て呼び出す
      
      
  \end{enumerate}
\end{enumerate}

以上の処理の後，\|submit|がリストコンテキストで呼び出されていた場合は，
各ジョブオブジェクトのメンバ\|thread|の値，すなわち生成したジョブスレッド
の配列を返り値として返す．配列におけるスレッドの順序は，
\|@|\textit{jobs}における対応するジョブオブジェクトの順序と等しい．
スカラコンテキストで呼び出されていた場合は，生成したジョブスレッドの数を返す．


\subsubsection{sync}
\subsubsection{spawn}
\subsubsection{builtin::join}

\section{Xcryptにおけるジョブの管理}

\section{ユーザ環境スクリプト}

\section{バッチスケジューラ定義スクリプト}

\section{コマンドラインインターフェース}

\section{拡張ライブラリ}

\end{document}
