#!/usr/bin/perl

use Tk;

$mw = MainWindow->new( -title => 'Xcryptgui' );
$mw->geometry( '600x600' );

$bn0 = $mw->Button( -text => 'xcrypt', -command => \&fun0 );
$br0 = '';
$ll0  = $mw->Label( -textvariable => \$br0 );
$bn0->place( -relx => '0.00', -relwidth  => '0.20',
	     -rely => '0.00', -relheight => '0.04' );
$ll0->place( -relx => '0.20', -relwidth  => '0.80',
	     -rely => '0.00', -relheight => '0.04' );

$bn1 = $mw->Button( -text => 'xcryptstat', -command => \&fun1 );
$bn1->place( -relx => '0.00', -relwidth  => '0.20',
	     -rely => '0.04', -relheight => '0.04' );

$bn2 = $mw->Button( -text => 'xcryptdel', -command => \&fun2 );
$bn2->place( -relx => '0.00', -relwidth  => '0.20',
	     -rely => '0.08', -relheight => '0.04' );

$bn3 = $mw->Button( -text => 'cleanup',
		     -command => sub { $br3 = 'Clean-up!';
				       system( "./cleanup.sh" ); } );
$br3 = '';
$ll3  = $mw->Label( -textvariable => \$br3 );
$bn3->place( -relx => '0.00', -relwidth  => '0.20',
	     -rely => '0.12', -relheight => '0.04' );
$ll3->place( -relx => '0.20', -relwidth  => '0.80',
	     -rely => '0.12', -relheight => '0.04' );

$bn4 = $mw->Button( -text => 'quit', -command => \&exit );
$bn4->place( -relx => '0.00', -relwidth  => '0.20',
	     -rely => '0.16', -relheight => '0.04' );

$fm0  = $mw->Frame();
$ll00 = $fm0->Label( -text => 'Main' );
$tt00 = $fm0->Scrolled( 'Text',
			 -background => 'white',
			 -scrollbars => 'se',
			 -wrap => 'none' );
$fm0->place( -relx => '0.00', -relwidth  => '0.50',
	     -rely => '0.20', -relheight => '0.80' );
$ll00->pack( -fill => 'both' );
$tt00->pack( -fill => 'both', -expand => 'true' );

$fm1  = $mw->Frame();
$ll10 = $fm1->Label( -text => 'State' );
$tt10 = $fm1->Scrolled( 'Text',
			 -background => 'white',
			 -scrollbars => 'se',
			 -wrap => 'none' );
$fm1->place( -relx => '0.50', -relwidth  => '0.50',
	     -rely => '0.20', -relheight => '0.40' );
$ll10->pack( -fill => 'both' );
$tt10->pack( -fill => 'both', -expand => 'true' );

$fm2  = $mw->Frame();
$ll20 = $fm2->Label( -text => 'Delete' );
$tt20 = $fm2->Scrolled( 'Text',
			 -background => 'white',
			 -scrollbars => 'se',
			 -wrap => 'none' );
$fm2->place( -relx => '0.50', -relwidth  => '0.50',
	     -rely => '0.60', -relheight => '0.40' );
$ll20->pack( -fill => 'both' );
$tt20->pack( -fill => 'both', -expand => 'true' );

sub fun2 {
    unless ( Exists( $tl20 ) ) {
	$tl20 = $mw->Toplevel( -title => 'Xcryptdel' );
	$lx20 = $tl20->Listbox();
	$lx20->pack( -side => 'left' );

	$bn20 = $tl20->Button( -text => 'OK', -command => \&foo );
	$bn20->pack( -fill => 'x' );

	$bn21 = $tl20->Button( -text => 'Cancel',
			       -command => ['destroy', $tl20] );
	$bn21->pack( -fill => 'x' );

	open( ID, '< inv_watch/.request_ids' );
	@allarr = split( / /, <ID> );
	%allhash = @allarr;
	@fileID = values(%allhash);
	foreach (@fileID) {
	    $lx20->insert('end', $_);
	    $lx20->yview('end');
	}
	close( ID );
    }
}

sub foo {
    @index = $lx20->curselection();

    unless (@index eq ()) {
	foreach (@index) {
	    $job = $lx20->get($_);
	    open( PIPE2, "xcryptdel $job |" ) or die "Can't delete $job";
	    $fm2->fileevent(\*PIPE2, 'readable', [\&bar, $tt20, 'PIPE2']);
	    $tl20->destroy();
	}
    }
}

sub fun0 {
    $filename = $mw->getOpenFile( -filetypes => [['Xcrypt Files', ['.xcr']]]);
    unless ($filename eq '') {
	$br0 = "$filename";
	open( PIPE0, "xcrypt $filename|" ) or die "Can't execute $filename";
	$fm0->fileevent(\*PIPE0, 'readable', [\&bar, $tt00, 'PIPE0']);
#	$tt10->focusForce();
    }
}

sub fun1 {
    open( PIPE1, "xcryptstat|" );
    while (<PIPE1>) {
	$tt10->insert('end', $_);
	$tt10->yview('end');
    }
    close( PIPE1 );
}

sub bar {
    my ($widget, $pipe) = @_;
    $_ = <$pipe>;
    $widget->insert('end', $_);
    $widget->yview('end');
}

MainLoop();
