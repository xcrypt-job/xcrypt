#!/usr/bin/env perl

#use strict;
use Tk;
use Tk::TList;

my $mainwindow = MainWindow->new( -title => 'Xcrypt' );
$mainwindow->geometry( '1000x1000' );

#my @fontlist = sort $mainwindow->fontFamilies;
my @fontlist = ('Helvetica');
my $menufontsize = 12;
my $fontsize = 14;

$mainwindow->optionAdd( '*Menu.font' => [$fontlist[0], $menufontsize, 'bold'] );
foreach ('*Button.font', '*Label.font') {
    $mainwindow->optionAdd( "$_" => [$fontlist[0], $fontsize, 'bold'] );
}

our ($eof0, $eof2);

my $toplevel2;
my $toplevel3;
my $tiler0;

my @buttonnames = ('Xcrypt...', 'Xcryptstat', 'Xcryptdel...');
my @labelnames = ('Main', 'Status', 'Aborted');
my $max = 2;
my $height = 0.15 / (1+$max);
my $width = 1 / (1+$max);
my $statcount;

sub connect {
    my ($widget, $pipe, $eof) = @_;

    my($stat, $data);
    $stat = sysread $pipe, $data, 4096;
    die "sysread error:  $!" unless defined $stat;
    if ($data =~ / abort$/) { $text2->insert('end', $data); }
    ${$widget}->insert('end', $data);
    ${$widget}->yview('end');

    if ($stat == 0) { ${$eof} = 1; }
}

my $menu = $mainwindow->Menu();
$menu->optionAdd( '*Menu.font' => [$fontlist[0], $menufontsize, 'bold'] );

$mainwindow->configure( -menu => $menu );
$menu->add( 'cascade', -label => 'File' );
$menu->add( 'cascade', -label => 'View' );
$menu->add( 'cascade', -label => 'Tool' );
$menu->add( 'cascade', -label => 'Help' );

my $file = $menu->Menu();
$menu->entryconfigure( 'File', -menu => $file );

foreach (0..$max) {
    my $button = $mainwindow->Button();
    $button->configure( -text => $buttonnames[$_], -command => [\&fun, $_] );
    $button->place( -relx => 0,              -relwidth  => 0.2,
		    -rely => ($_ * $height), -relheight => $height );
    $file->add( 'command', -label => "$buttonnames[$_]", -command => [\&fun, $_] );

    my $frame = $mainwindow->Frame();
    $frame->place( -relx => ($_ * $width), -relwidth  => $width,
		   -rely => 0.15,          -relheight => 0.85    );

    my $buffername = 'buffer' . $_;
    eval "our \$$buffername = \'\';";

    my $labelname = 'label' . $_ ;
    eval "our \$$labelname = \$mainwindow->Label();";
    ${$labelname}->configure( -textvariable => \$$buffername );
    ${$labelname}->place( -relx => 0.2,            -relwidth  => 0.8,
			  -rely => ($_ * $height), -relheight => $height );

    my $sublabel = 'sublabel' . $_;
    eval "our \$$sublabel = \$frame->Label();";
    ${$sublabel}->configure( -text => "$labelnames[$_]" );
    ${$sublabel}->pack( -fill => 'both' );

    my $text = 'text' . $_;
    eval "our \$$text = \$frame->Scrolled( \'Text\' );";
    ${$text}->configure( -font => [$fontlist[0], $fontsize, 'normal'],
			-background => 'white',
			-scrollbars => 'se',
			-wrap => 'none' );
    ${$text}->pack( -fill => 'both', -expand => 'true' );
}

$file->add( 'separator' );
$file->add( 'command', -label => 'Exit', -command => \&exit );

sub fun {
    if ($_[0] == 0) {
	my $filename = $mainwindow->getOpenFile(
	    -font => [$fontlist[0], $fontsize, 'normal'],
	    -filetypes => [['Xcrypt Files', ['.xcr']],
			   ['All Files', ['*']]]);
	unless ($filename eq '') {
	    $buffer0 = "xcrypt $filename";
	    $eof0 = 0;
	    open( PIPE0, "xcrypt $filename|" ) or warn "Can't execute $filename";
	    $mainwindow->fileevent( \*PIPE0, 'readable',
				    [\&connect, 'text0', 'PIPE0', 'eof0'] );

	    $mainwindow->waitVariable(\$eof0);
	    $mainwindow->fileevent( \*PIPE0, 'readable' => '' );
	    close PIPE0;
	}
    } elsif ($_[0] == 1) {
	$statcount = $statcount + 1;
	$buffer1 = "xcryptstat executed ($statcount times)";
	open( PIPE1, "xcryptstat|" );
	while (<PIPE1>) {
	    $text1->insert('end', $_);
	    $text1->yview('end');
	}
    } elsif ($_[0] == 2) {
	unless ( Exists( $toplevel2 ) ) {
	    $toplevel2 = $mainwindow->Toplevel( -title => 'Xcryptdel' );
	    my $listbox = $toplevel2->Scrolled( 'Listbox',
						-scrollbars => 'se',
						-font => [$fontlist[0],
							  $fontsize, 'bold'] );
	    $listbox->pack( -side => 'left' );

	    my $button0 = $toplevel2->Button( -text => 'OK',
					      -command => [\&del2, $listbox] );
	    $button0->pack( -fill => 'x' );

	    my $button1 = $toplevel2->Button( -text => 'Cancel',
					      -command => ['destroy', $toplevel2] );
	    $button1->pack( -fill => 'x' );

	    open( ID, '< inv_watch/.request_ids' );
	    my @reqid_jobids = split( / /, <ID> );
	    my %hash = @reqid_jobids;
	    my %count;
	    my @vals = values(%hash);
	    @vals = grep(!$count{$_}++, @vals);
	    my @jobids = sort @vals;
	    foreach (@jobids) {
		$listbox->insert('end', $_);
		$listbox->yview('end');
	    }
	}
    } else {}
}

sub del2 {
    my @index = $_[0]->curselection();
    unless (@index eq ()) {
	foreach (@index) {
	    my $job = $_[0]->get($_);
	    $eof2 = 0;
	    open( PIPE2, "xcryptdel $job |" ) or warn "Can't delete $job";
	    $mainwindow->fileevent( \*PIPE2, 'readable',
				    [\&connect, 'text2', 'PIPE2', 'eof2'] );

	    $mainwindow->waitVariable(\$eof2);
	    $mainwindow->fileevent( \*PIPE2, 'readable' => '' );
	    close PIPE2;

	    $toplevel2->destroy();

	    $buffer2 = "xcryptdel $job";
	}
    }
}

my $view = $menu->Menu();
$menu->entryconfigure( 'View', -menu => $view );
$view->add( 'cascade', -label => 'Size' );
my $size = $view->Menu();
$view->entryconfigure( 'Size', -menu => $size );
foreach (8..24) {
    $size->add( 'command', -label => $_, -command => [\&sizechange, $_] );
}

sub sizechange {
    $fontsize = $_[0];
    my @bold = ('label0', 'label1', 'label2',
		'button0', 'button1', 'button2',
		'sublabel0', 'sublabel1', 'sublabel2');
    foreach (@bold) {
	${$_}->configure( -font => [$fontlist[0], $fontsize, 'bold']);
    }
    my @normal = ('text0', 'text1', 'text2');
    foreach (@normal) {
	${$_}->configure( -font => [$fontlist[0], $fontsize, 'normal']);
    }
}

my $tool = $menu->Menu();
$menu->entryconfigure( 'Tool', -menu => $tool );
$tool->add( 'command', -label => 'Clean',
	    -command => sub { system( "./cleanup.sh" ); } );
$tool->add( 'command', -label => 'Monitor', -command => \&monitor );

sub monitoring {
#    lock($tiler0);
    open( REQ, '< inv_watch/.request_ids' );
    my %reqid_jobids = split(' ', <REQ>);
    my %count;
    my @vals = values(%reqid_jobids);
    @vals = grep(!$count{$_}++, @vals);
    my @jobids = sort @vals;
    close( REQ );
    my %jobcolors = ( 'done' => 'green',
		      'abort' => 'red',
		      'aborted' => 'red',
		      'active' => 'yellow',
		      'submitted' => 'yellow',
		      'queued' => 'yellow',
		      'running' => 'yellow'
	);

    my $lt = @jobids;
    if ($lt > 0) {
	$tiler0->delete(0, $lt-1);
    }
    foreach (@jobids) {
	open( JOB, "< inv_watch/$_" );
	while( $line = <JOB> ){
	    if ($line =~ /^status\:\s*(.+)/) {
		$status = $1;
	    }
	}
	close( JOB );
	my $button = $tiler0->Button( -text => $_,
				      -background => $jobcolors{$status},
#				      -command => [\&del3, $_]
	    );
	my $label = $tiler0->Label( -text => $_,
#				    -foreground => $jobcolors{$status},
				    -background => $jobcolors{$status},
	    );
	$tiler0->insert('end',
			-itemtype => 'window',
			-window => $label
	    );
    }
}

sub monitor {
    unless ( Exists( $toplevel3 ) ) {
	$toplevel3 = $mainwindow->Toplevel( -title => 'Monitor' );
	$toplevel3->geometry( '600x600' );
#	$toplevel3->Label( -text => 'Click a job-button if you want to kill it')->pack();

	$tiler0 = $toplevel3->Scrolled( 'TList',
					-font => [$fontlist[0],
						  $fontsize, 'bold'],
					-background => 'white',
					-scrollbars => 'e',
					-orient => 'horizontal'
	    );

	$tiler0->pack( -expand => 'yes', -fill => 'both', -side => 'left' );

	my $button0_m = $toplevel3->Button( -text => 'Reload',
					    -command => [\&monitoring] );
	$button0_m->pack( -fill => 'x' );

	my $button1_m = $toplevel3->Button( -text => 'Close',
					    -command => ['destroy', $toplevel3] );
	$button1_m->pack( -fill => 'x' );

	my $button2_m = $toplevel3->Button( -text => 'Delete',
#					    -command => [\&del3, $tiler0->curselection] );
#					    -command => sub { print $tiler0->infoSelection(); } );
					    -command => [\&del3, $tiler0] );
	$button2_m->pack( -fill => 'x' );

	&monitoring();
    }
}

sub del3 {
    if (defined $_[0]) {
	open( REQ, '< inv_watch/.request_ids' );
	my %reqid_jobids = split(' ', <REQ>);
	my %count;
	my @vals = values(%reqid_jobids);
	@vals = grep(!$count{$_}++, @vals);
	my @jobids = sort @vals;
	close( REQ );

#	print $_[0]->infoSelection() , "\n";
	my @hoge = $_[0]->infoSelection();
	my $job = $jobids[$hoge[0]];
	$eof2 = 0;
	open( PIPE2, "xcryptdel $job |" ) or warn "Can't delete $job";
	$mainwindow->fileevent( \*PIPE2, 'readable',
				[\&connect, 'text2', 'PIPE2', 'eof2'] );

	$mainwindow->waitVariable(\$eof2);
	$mainwindow->fileevent( \*PIPE2, 'readable' => '' );
	close PIPE2;

	$buffer2 = "xcryptdel $job";
    }
}

my $help = $menu->Menu();
$menu->entryconfigure( 'Help', -menu => $help );
$help->add( 'command', -label => 'Manual...',
	    -command => sub {
		system( "acroread $ENV{XCRYPT}/doc/Xcrypt_manual.pdf" );
	    } );

MainLoop();
