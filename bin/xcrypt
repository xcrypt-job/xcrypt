#!/usr/bin/env perl
package xcrypt;

use strict;
use File::Copy;
use File::Spec;
use File::Basename;
use Getopt::Long;

my $xcrfile = shift @ARGV;

if (File::Spec->catfile(basename($xcrfile)) !~ /\.xcr\Z/) {
    warn "The first argument should be an Xcrypt script.\n";
}

my $xcrplfile = "$xcrfile" . '.pl';
if ( -e $xcrplfile ) {
#    print "The old $xcrplfile replaced by the new $xcrplfile\n";
    unlink $xcrplfile;
}

open(USER , "< $xcrfile") or die "Can't open $xcrfile\n";
open(TMP , "> $xcrplfile") or die "Can't open $xcrfile\n";
print TMP 'package user;' . "\n";
print TMP 'use xcropt;' . "\n";
print TMP 'use builtin;' . "\n";
print TMP 'use Coro;' . "\n";
print TMP 'use jobsched;' . "\n";
print TMP 'our @VALUE = ();' . "\n";
#print TMP 'sub before {local $self = shift; foreach my $i (0..$#_) { my $tmp = "RANGE$i"; eval "our \$$tmp = \$_[$i];"; }; if ($self->{before}) {&{$self->{before}}(@{$self->{VALUE}})};}' . "\n";
print TMP 'sub before {local ($self, @VALUE) = @_; if ($self->{before}) {&{$self->{before}}($self, @VALUE)};}' . "\n";
print TMP 'sub start  {my $self = shift;$self->SUPER::start();}' . "\n";
#print TMP 'sub after  {local $self = shift; foreach my $i (0..$#_) { my $tmp = "RANGE$i"; eval "our \$$tmp = \$_[$i];"; }; if ($self->{after} ) {&{$self->{after}}(@{$self->{VALUE}})};}' . "\n";
print TMP 'sub after  {local ($self, @VALUE) = @_; if ($self->{after} ) {&{$self->{after}}($self, @VALUE)};}' . "\n";

print TMP '# Up to here Xcrypt\'s header.  From here your script.' . "\n";
print TMP '&jobsched::read_log();' . "\n";
print TMP '&jobsched::invoke_abort_check();' . "\n";
print TMP '&jobsched::invoke_left_message_check();' . "\n";
#print TMP '&jobsched::invoke_watch();' . "\n";
print TMP 'if (defined $xcropt::options{rhost}) { if (defined $xcropt::options{rwd}) { $builtin::env_d = &add_host({"host" => $xcropt::options{rhost}, "wd" => $xcropt::options{rwd}, "location" => "remote"}); } else { $builtin::env_d = &add_host({"host" => $xcropt::options{rhost}, "location" => "remote"}); } }' . "\n";
foreach (<USER>) { print TMP "$_"; }
print TMP '# Up to here your script.  From here Xcrypt\'s footer.' . "\n";
#print TMP '&jobsched::check_and_write_aborted();' . "\n";
#print TMP 'sleep(1);' . "\n";
close(TMP);
close(USER);

chmod 0755, $xcrplfile or die "Can't chmod $xcrplfile\n";
my $exitcode = system("perl $xcrplfile " . join(' ', @ARGV));
unless ($exitcode == 0) { die "Can't perl $xcrplfile\n"; }
