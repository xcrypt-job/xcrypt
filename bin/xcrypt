#!/usr/bin/env perl
package xcrypt;

use strict;
use File::Copy;
use File::Spec;
use File::Basename;
use Getopt::Long;

foreach ('XCRYPT', 'XCRJOBSCHED','PERL5LIB') {
    unless (defined $ENV{"$_"}) {
	die "Set the environment varialble $_\n";
    }
}

my $xcrfile = shift @ARGV;
if (File::Spec->catfile(basename($xcrfile)) !~ /\.xcr\Z/) {
    die "A first argument should be an Xcrypt script.\n";
}

my $xcrplfile = "$xcrfile" . '.pl';
if ( -e $xcrplfile ) { unlink $xcrplfile; }

open(USER , "< $xcrfile") or die "Can't open $xcrfile\n";
open(TMP , "> $xcrplfile") or die "Can't open $xcrplfile\n";
print TMP 'package user;' . "\n";
print TMP 'use xcropt;' . "\n";
print TMP 'use builtin;' . "\n";
print TMP 'use threads;' . "\n";
print TMP 'use threads::shared;' . "\n";
print TMP 'use jobsched;' . "\n";
print TMP 'our $maxargetc = \'255\';' . "\n";
print TMP 'our $maxrange = \'16\';' . "\n";
print TMP 'our $expandingchar = \'@\';' . "\n";
print TMP 'our $smph : shared;' . "\n";
print TMP 'our $separator_nocheck = \'0\';' . "\n";
print TMP 'our $separator = \'_\';' . "\n";
print TMP '&builtin::invoke_after();' . "\n";
print TMP '&jobsched::invoke_watch();' . "\n";
print TMP '&jobsched::invoke_abort_check();' . "\n";
print TMP 'sub before {my $self = shift;eval($self->{before});$self->SUPER::before();}' . "\n";
print TMP 'sub start  {my $self = shift;$self->SUPER::start();}' . "\n";
print TMP 'sub after  {my $self = shift;$self->SUPER::after();eval($self->{after});}' . "\n";
print TMP '# Up to here Xcrypt\'s header.  From here your script.' . "\n";
foreach (<USER>) { print TMP "$_"; }
print TMP '# Up to here your script.  From here Xcrypt\'s footer.' . "\n";
print TMP 'sleep(2);' . "\n";
print TMP '$builtin::after_thread->detach;' . "\n";
print TMP '$jobsched::watch_thread->detach;' . "\n";
print TMP '$jobsched::abort_check_thread->detach;' . "\n";
close(TMP);
close(USER);

chmod 0755, $xcrplfile or die "Can't chmod $xcrplfile\n";
my $exitcode = system("perl $xcrplfile " . join(' ', @ARGV));
unless ($exitcode == 0) { die "Can't perl $xcrplfile\n"; }
